// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
syntax = "proto3";

package azdext;

option go_package = "github.com/azure/azure-dev/cli/azd/pkg/azdext";

import "models.proto";
import "service_target.proto";
import "include/google/protobuf/struct.proto";

// ProjectService defines methods for managing projects and their configurations.
service ProjectService {
  // Gets the current project.
  rpc Get(EmptyRequest) returns (GetProjectResponse);

  // GetServiceTargetResource resolves the target Azure resource for a service.
  // This uses azd's standard resource discovery logic which:
  // - Looks up resources by azd-service-name tag
  // - Falls back to explicit resourceName from configuration
  // - Resolves the resource group name from configuration or environment
  // The returned TargetResource includes subscription, resource group, resource name, and resource type.
  rpc GetServiceTargetResource(GetServiceTargetResourceRequest) returns (GetServiceTargetResourceResponse);

  // AddService adds a new service to the project.
  rpc AddService(AddServiceRequest) returns (EmptyResponse);

  // GetResolvedServices gets the resolved list of services after processing any importers (e.g., Aspire projects).
  // This returns the actual services that will be deployed, including those generated by importers.
  rpc GetResolvedServices(EmptyRequest) returns (GetResolvedServicesResponse);

  // ParseGitHubUrl parses a GitHub URL and extracts repository information.
  rpc ParseGitHubUrl(ParseGitHubUrlRequest) returns (ParseGitHubUrlResponse);

  // Gets a configuration section by path.
  rpc GetConfigSection(GetProjectConfigSectionRequest) returns (GetProjectConfigSectionResponse);

  // Gets a configuration value by path.
  rpc GetConfigValue(GetProjectConfigValueRequest) returns (GetProjectConfigValueResponse);

  // Sets a configuration section by path.
  rpc SetConfigSection(SetProjectConfigSectionRequest) returns (EmptyResponse);

  // Sets a configuration value by path.
  rpc SetConfigValue(SetProjectConfigValueRequest) returns (EmptyResponse);

  // Removes configuration by path.
  rpc UnsetConfig(UnsetProjectConfigRequest) returns (EmptyResponse);

  // Gets a service configuration section by path.
  rpc GetServiceConfigSection(GetServiceConfigSectionRequest) returns (GetServiceConfigSectionResponse);

  // Gets a service configuration value by path.
  rpc GetServiceConfigValue(GetServiceConfigValueRequest) returns (GetServiceConfigValueResponse);

  // Sets a service configuration section by path.
  rpc SetServiceConfigSection(SetServiceConfigSectionRequest) returns (EmptyResponse);

  // Sets a service configuration value by path.
  rpc SetServiceConfigValue(SetServiceConfigValueRequest) returns (EmptyResponse);

  // Removes service configuration by path.
  rpc UnsetServiceConfig(UnsetServiceConfigRequest) returns (EmptyResponse);
}

// GetProjectResponse message definition
message GetProjectResponse {
  ProjectConfig project = 1;
}

// AddServiceRequest message definition
message AddServiceRequest {
  ServiceConfig service = 1;
}

// GetResolvedServicesResponse message definition
message GetResolvedServicesResponse {
  // Map of service name to service configuration
  map<string, ServiceConfig> services = 1;
}

// ParseGitHubUrlRequest message definition
message ParseGitHubUrlRequest {
  string url = 1;
}

// Request message for GetConfigSection
message GetProjectConfigSectionRequest {
  string path = 1;
}

// Response message for GetConfigSection
message GetProjectConfigSectionResponse {
  google.protobuf.Struct section = 1;
  bool found = 2;
}

// ParseGitHubUrlResponse message definition
message ParseGitHubUrlResponse {
  string hostname = 1;
  string repo_slug = 2;
  string branch = 3;
  string file_path = 4;
}

// Request message for GetConfigValue
message GetProjectConfigValueRequest {
  string path = 1;
}

// Response message for GetConfigValue
message GetProjectConfigValueResponse {
  google.protobuf.Value value = 1;
  bool found = 2;
}

// Request message for SetConfigSection
message SetProjectConfigSectionRequest {
  string path = 1;
  google.protobuf.Struct section = 2;
}

// Request message for SetConfigValue
message SetProjectConfigValueRequest {
  string path = 1;
  google.protobuf.Value value = 2;
}

// Request message for UnsetConfig
message UnsetProjectConfigRequest {
  string path = 1;
}

// Request message for GetServiceConfigSection
message GetServiceConfigSectionRequest {
  string service_name = 1;
  string path = 2;
}

// Response message for GetServiceConfigSection
message GetServiceConfigSectionResponse {
  google.protobuf.Struct section = 1;
  bool found = 2;
}

// Request message for GetServiceConfigValue
message GetServiceConfigValueRequest {
  string service_name = 1;
  string path = 2;
}

// Response message for GetServiceConfigValue
message GetServiceConfigValueResponse {
  google.protobuf.Value value = 1;
  bool found = 2;
}

// Request message for SetServiceConfigSection
message SetServiceConfigSectionRequest {
  string service_name = 1;
  string path = 2;
  google.protobuf.Struct section = 3;
}

// Request message for SetServiceConfigValue
message SetServiceConfigValueRequest {
  string service_name = 1;
  string path = 2;
  google.protobuf.Value value = 3;
}

// Request message for UnsetServiceConfig
message UnsetServiceConfigRequest {
  string service_name = 1;
  string path = 2;
}

// Request message for GetServiceTargetResource
message GetServiceTargetResourceRequest {
  // The name of the service to resolve the target resource for
  string service_name = 1;
}

// Response message for GetServiceTargetResource
message GetServiceTargetResourceResponse {
  // The resolved target resource including subscription, resource group, resource name, and resource type
  TargetResource target_resource = 1;
}
