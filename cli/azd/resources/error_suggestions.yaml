# Error Suggestions Configuration
# ================================
# This file maps well-known error patterns to user-friendly messages and actionable suggestions.
# Rules are evaluated in order; the first matching rule wins.
#
# Matching Fields (at least one required):
#   - patterns:   List of strings/regex to match against error message text
#   - errorType:  Go error struct type name to match via reflection (e.g., "AzureDeploymentError")
#   - properties: Map of dot-path property names to expected values on the matched error type
#
# When multiple matching fields are specified, ALL must match for the rule to trigger.
#
# Response Fields:
#   - message:    User-friendly explanation of what went wrong
#   - suggestion: Actionable next steps to resolve the issue
#   - docUrl:     Optional link to documentation
#   - handler:    Optional name of a registered ErrorHandler for dynamic suggestions
#
# Pattern Types:
#   - Default: Case-insensitive substring match (e.g., "quota exceeded")
#   - Regex: Set "regex: true" on the rule to treat all patterns and property
#     values as regular expressions (e.g., "BCP\\d{3}")
#
# Examples:
#   # Text pattern matching:
#   - patterns:
#       - "some error text"
#     message: "A brief, user-friendly explanation."
#     suggestion: "Clear instruction on how to fix."
#
#   # Typed error matching with properties:
#   - errorType: "AzureDeploymentError"
#     properties:
#       Details.Code: "InsufficientQuota"
#     message: "Quota limit reached."
#     suggestion: "Request a quota increase."

rules:
  # ============================================================================
  # ARM Deployment Errors — Soft-delete conflicts
  # 4th most common error category (~128,054 errors in 90-day analysis)
  # ============================================================================

  - errorType: "AzureDeploymentError"
    properties:
      Details.Code: "FlagMustBeSetForRestore"
    message: "A soft-deleted resource with this name exists and is blocking deployment."
    suggestion: >
      Purge the resource in the Azure portal or via the Azure CLI,
      then retry with 'azd up'. If the resources are still provisioned,
      running 'azd down --purge' will delete and purge them.
    docUrl: "https://learn.microsoft.com/azure/key-vault/general/key-vault-recovery"

  - errorType: "AzureDeploymentError"
    properties:
      Details.Code: "ConflictError"
    message: "A resource conflict occurred, possibly caused by a soft-deleted resource."
    suggestion: >
      Purge the resource in the Azure portal or via the Azure CLI,
      then retry with 'azd up'. If the resources are still provisioned,
      running 'azd down --purge' will delete and purge them.

  - errorType: "AzureDeploymentError"
    regex: true
    properties:
      Details.Code: "Conflict"
    patterns:
      - "(?i)soft.?delete"
      - "(?i)purge"
      - "(?i)deleted vault"
      - "(?i)deleted resource"
      - "(?i)recover or purge"
    message: "A soft-deleted resource is causing a deployment conflict."
    suggestion: >
      Purge the soft-deleted resource in the Azure portal or via the
      Azure CLI, then retry with 'azd up'. If the resources are still
      provisioned, running 'azd down --purge' will delete and purge them.
    docUrl: "https://learn.microsoft.com/azure/key-vault/general/key-vault-recovery"

  - errorType: "AzureDeploymentError"
    regex: true
    properties:
      Details.Code: "RequestConflict"
    patterns:
      - "(?i)soft.?delete"
      - "(?i)purge"
      - "(?i)deleted vault"
      - "(?i)deleted resource"
      - "(?i)recover or purge"
    message: "A soft-deleted resource is causing a deployment conflict."
    suggestion: >
      Purge the soft-deleted resource in the Azure portal or via the
      Azure CLI, then retry with 'azd up'. If the resources are still
      provisioned, running 'azd down --purge' will delete and purge them.

  # ============================================================================
  # ARM Deployment Errors — Quota and capacity
  # ARM errors account for ~45% of all azd errors (~57,956)
  # ============================================================================

  - errorType: "AzureDeploymentError"
    properties:
      Details.Code: "InsufficientQuota"
    message: "Your subscription has insufficient quota for this resource."
    suggestion: >
      Check current usage with 'az vm list-usage --location <region>'
      or request a quota increase in the Azure portal.
    docUrl: "https://learn.microsoft.com/azure/quotas/quickstart-increase-quota-portal"

  - errorType: "AzureDeploymentError"
    properties:
      Details.Code: "SubscriptionIsOverQuotaForSku"
    message: "Your subscription quota for this SKU is exceeded."
    suggestion: "Request a quota increase or use a different SKU."
    docUrl: "https://learn.microsoft.com/azure/quotas/quickstart-increase-quota-portal"

  # ============================================================================
  # ARM Deployment Errors — Region and SKU availability
  # ============================================================================

  - errorType: "AzureDeploymentError"
    properties:
      Details.Code: "SkuNotAvailable"
    message: "The requested VM size or SKU is not available in this region."
    suggestion: "Try a different region with 'azd env set AZURE_LOCATION <region>'."
    docUrl: "https://learn.microsoft.com/azure/azure-resource-manager/troubleshooting/error-sku-not-available"

  - errorType: "AzureDeploymentError"
    properties:
      Details.Code: "LocationIsOfferRestricted"
    message: "This resource type is restricted in the selected region."
    suggestion: "Try a different region with 'azd env set AZURE_LOCATION <region>'."

  # ============================================================================
  # ARM Deployment Errors — Authorization
  # ============================================================================

  - errorType: "AzureDeploymentError"
    properties:
      Details.Code: "AuthorizationFailed"
    message: "You do not have sufficient permissions for this deployment."
    suggestion: >
      Ensure you have the required RBAC role (e.g., Owner or Contributor)
      on the target subscription.
    docUrl: "https://learn.microsoft.com/azure/role-based-access-control/role-assignments-portal"

  # ============================================================================
  # ARM Deployment Errors — Template and validation
  # ============================================================================

  - errorType: "AzureDeploymentError"
    properties:
      Details.Code: "InvalidTemplate"
    message: "The deployment template contains errors."
    suggestion: "Run 'azd provision --preview' to validate before deploying."

  - errorType: "AzureDeploymentError"
    properties:
      Details.Code: "ValidationError"
    message: "The deployment failed validation."
    suggestion: >
      Check resource property values and API versions
      in your Bicep/Terraform files.

  # ============================================================================
  # ARM Deployment Errors — Resource conflicts
  # ============================================================================

  - errorType: "AzureDeploymentError"
    properties:
      Details.Code: "Conflict"
    message: "A resource with this name already exists or is in a conflicting state."
    suggestion: "Check for existing or soft-deleted resources in the Azure portal."

  - errorType: "AzureDeploymentError"
    properties:
      Details.Code: "ResourceNotFound"
    message: "A referenced resource was not found."
    suggestion: >
      Check resource dependencies and deployment ordering
      in your template.

  # ============================================================================
  # PowerShell Hook Failures
  # ~5% of all azd errors (~6,347); AI templates hit 6.59%
  # ============================================================================

  - errorType: "ExitError"
    regex: true
    properties:
      Cmd: "(?i)pwsh|powershell"
    patterns:
      - "Import-Module"
      - "not loaded"
    message: "A required PowerShell module could not be loaded."
    suggestion: "Install the missing module with 'Install-Module <ModuleName> -Scope CurrentUser'."

  - errorType: "ExitError"
    regex: true
    properties:
      Cmd: "(?i)pwsh|powershell"
    patterns:
      - "'Az."
      - "is not recognized"
    message: "The Azure PowerShell module (Az) is required but not installed."
    suggestion: "Install it with 'Install-Module Az -Scope CurrentUser -Repository PSGallery -Force'."
    docUrl: "https://learn.microsoft.com/powershell/azure/install-azure-powershell"

  - errorType: "ExitError"
    regex: true
    properties:
      Cmd: "(?i)pwsh|powershell"
    patterns:
      - "UnauthorizedAccess"
    message: "PowerShell execution policy is blocking the script."
    suggestion: >
      Check your policy with 'Get-ExecutionPolicy' and consider setting it with
      'Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser'.

  - errorType: "ExitError"
    regex: true
    properties:
      Cmd: "(?i)pwsh|powershell"
    patterns:
      - "ErrorActionPreference"
    message: "The hook script has an issue with error handling configuration."
    suggestion: "Ensure '$ErrorActionPreference = \"Stop\"' is set at the top of the script."

  - errorType: "ExitError"
    regex: true
    properties:
      Cmd: "(?i)pwsh|powershell"
    patterns:
      - "Connect-AzAccount"
    message: "The Azure authentication session may have expired."
    suggestion: "Run 'azd auth login' to refresh your credentials, then retry."

  - errorType: "ExitError"
    regex: true
    properties:
      Cmd: "(?i)pwsh|powershell"
    patterns:
      - "(?i)login.*expired|expired.*login"
    message: "The Azure authentication session may have expired."
    suggestion: "Run 'azd auth login' to refresh your credentials, then retry."

  # ============================================================================
  # Project Configuration Errors
  # ============================================================================

  - patterns:
      - "parsing project file"
    message: "Your azure.yaml file is invalid."
    suggestion: "Check the syntax of your azure.yaml file and fix any errors."
    docUrl: "https://aka.ms/azure-dev/azure-yaml"

  # ============================================================================
  # Authentication Errors
  # ============================================================================

  - patterns:
      - "AADSTS"
    message: "Authentication with Azure failed."
    suggestion: "Run 'azd auth login' to sign in again."
    docUrl: "https://learn.microsoft.com/azure/developer/azure-developer-cli/reference#azd-auth-login"

  - patterns:
      - "InvalidAuthenticationToken"
      - "ExpiredAuthenticationToken"
      - "TokenExpired"
    message: "Your authentication token has expired."
    suggestion: "Run 'azd auth login' to sign in again."
    docUrl: "https://learn.microsoft.com/azure/developer/azure-developer-cli/reference#azd-auth-login"

  # ============================================================================
  # Bicep Template Errors
  # ============================================================================

  - regex: true
    patterns:
      - "BCP\\d{3}"
    message: "Your Bicep template has an error."
    suggestion: "Review the error message for the specific issue and line number in your .bicep file."
    docUrl: "https://learn.microsoft.com/azure/azure-resource-manager/bicep/bicep-error-codes"

  # ============================================================================
  # Quota Errors (text pattern fallback for non-ARM errors)
  # ============================================================================

  - patterns:
      - "QuotaExceeded"
      - "quota exceeded"
      - "exceeds quota"
      - "OperationNotAllowed"
    message: "Your Azure subscription has reached a resource quota limit."
    suggestion: "Request a quota increase through the Azure portal, or try deploying to a different region."
    docUrl: "https://learn.microsoft.com/azure/quotas/quickstart-increase-quota-portal"
