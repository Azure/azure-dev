resources:
  repositories:
    - repository: azure-sdk-build-tools
      type: git
      name: internal/azure-sdk-build-tools
      ref: refs/tags/azure-sdk-build-tools_20230613.1

# Continuous deployment trigger
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - go.mod
      - cli/
      - eng/pipelines/release-cli.yml

pr:
  paths:
    include:
      - go.mod
      - cli/
      - eng/pipelines/release-cli.yml
      - eng/pipelines/templates/steps/publish-cli.yml

variables:
  - template: /eng/pipelines/templates/variables/globals.yml

stages:
  - stage: BuildAndTest
    jobs:
      - job: BuildCLI
        strategy:
          matrix:
            Windows:
              Pool: azsdk-pool-mms-win-2022-general
              OSVmImage: MMS2022
              BuildTarget: azd-windows-amd64.exe
              BuildOutputName: azd.exe
              BuildTestMsi: true
              AZURE_DEV_CI_OS: win
              Codeql.Enabled: true
              Codeql.SkipTaskAutoInjection: false
              Codeql.BuildIdentifier: cli_windows
            Linux:
              Pool: azsdk-pool-mms-ubuntu-2004-general
              OSVmImage:  MMSUbuntu20.04
              BuildTarget: azd-linux-amd64
              BuildOutputName: azd
              SetExecutableBit: true
              SetShieldInfo: true
              BuildLinuxPackages: true
              AZURE_DEV_CI_OS: lin
              Codeql.Enabled: true
              Codeql.SkipTaskAutoInjection: false
              Codeql.BuildIdentifier: cli_linux
            Mac:
              Pool: Azure Pipelines
              OSVmImage: macOS-11
              BuildTarget: azd-darwin-amd64
              BuildOutputName: azd
              MacLocalSign: false
              SetExecutableBit: true
              AZURE_DEV_CI_OS: mac
              # CodeQL on macOS not supported by the Azure DevOps task as-of current.
              # Codeql.BuildIdentifier: cli_darwin
        pool:
            name: $(Pool)
            vmImage: $(OSVmImage)
        timeoutInMinutes: 180
        steps:
          - checkout: self
          - template: /eng/pipelines/templates/steps/setup-go.yml
            parameters:
              Condition: and(succeeded(), ne(variables['Skip.LiveTest'], 'true'))

          - template: /eng/pipelines/templates/steps/set-cli-version-cd.yml

          - task: PowerShell@2
            inputs:
              pwsh: true
              targetType: filePath
              filePath: eng/scripts/Set-CliVersionVariable.ps1
            displayName: Set CLI_VERSION

          - task: PowerShell@2
            inputs:
              pwsh: true
              targetType: filePath
              filePath: eng/scripts/Set-CliBuildVariables.ps1
              arguments: -BuildReason $(Build.Reason)
            displayName: Set CLI build run variables

          - task: PowerShell@2
            inputs:
              pwsh: true
              targetType: filePath
              filePath: cli/azd/ci-build.ps1
              arguments: >-
                -Version $(CLI_VERSION)
                -SourceVersion $(Build.SourceVersion)
                -CodeCoverageEnabled
                -BuildRecordMode
              workingDirectory: cli/azd
            displayName: Build Go Binary (For tests)

          - template: /eng/pipelines/templates/steps/build-msi.yml
            parameters:
              Title: Build Test MSI
              Condition: and(succeeded(), eq(variables['BuildTestMsi'], 'true'))

          - template: /eng/pipelines/templates/steps/install-terraform.yml
          - template: /eng/pipelines/templates/steps/install-kubectl.yml

          # Pinning DockerInstaller to 0.209.0 because 0.214.0 has failures.
          # Remove this pin when later versions succeed.
          - task: DockerInstaller@0.209.0
            displayName: Docker Installer
            condition: and(succeeded(), contains(variables['OSVmImage'], 'macOS'))
            inputs:
              dockerVersion: 17.09.0-ce
              releaseType: stable

          # Live testing uses dotnet 6.0.x in the WebApp project deployment
          - task: UseDotNet@2
            condition: and(succeeded(), ne(variables['Skip.LiveTest'], 'true'))
            inputs:
              version: 6.0.x

          - template: /eng/pipelines/templates/steps/az-login.yml
            parameters:
              Condition: and(succeeded(), ne(variables['Skip.LiveTest'], 'true'))

          - template: /eng/pipelines/templates/steps/azd-login.yml
            parameters:
              AzdDirectory: cli/azd

          - task: PowerShell@2
            condition: and(succeeded(), ne(variables['Skip.LiveTest'], 'true'))
            inputs:
              pwsh: true
              targetType: filePath
              filePath: cli/azd/ci-test.ps1
              arguments: >-
                -UnitTestCoverageDir './cover-$(AZURE_DEV_CI_OS)/unit'
                -IntegrationTestCoverageDir './cover-$(AZURE_DEV_CI_OS)/int'
              workingDirectory: cli/azd
            displayName: Test Go Binary
            env:
              # AZD live test setup variables
              CI: true
              AZD_TEST_CLI_VERSION: $(CLI_VERSION)
              AZD_TEST_CLIENT_ID: $(arm-client-id)
              AZD_TEST_CLIENT_SECRET: $(arm-client-secret)
              AZD_TEST_TENANT_ID: $(arm-tenant-id)
              AZD_TEST_AZURE_SUBSCRIPTION_ID: $(SubscriptionId)
              AZD_TEST_AZURE_LOCATION: eastus2
              AZURE_RECORD_MODE: $(AZURE_RECORD_MODE)
              # AZD Live Test: Terraform service principal authentication
              ARM_CLIENT_ID: $(arm-client-id)
              ARM_CLIENT_SECRET: $(arm-client-secret)
              ARM_TENANT_ID: $(arm-tenant-id)
              # Code Coverage: Generate junit report to publish results
              GOTESTSUM_JUNITFILE: junitTestReport.xml

          - task: PublishTestResults@2
            inputs:
              testResultsFormat: JUnit
              testResultsFiles: '**/junitTestReport.xml'
              testRunTitle: $(Agent.JobName)
              searchFolder: cli/azd
              publishRunAttachments: true
            displayName: Publish test results
            condition: succeededOrFailed()

          - task: PowerShell@2
            inputs:
              pwsh: true
              targetType: filePath
              filePath: cli/azd/ci-build.ps1
              arguments: >-
                -Version $(CLI_VERSION)
                -SourceVersion $(Build.SourceVersion)
              workingDirectory: cli/azd
            displayName: Build Go Binary

          - pwsh: Move-Item $(BuildOutputName) $(BuildTarget)
            workingDirectory: cli/azd
            displayName: Rename binaries

          - bash: chmod +x $(BuildTarget)
            condition: and(succeeded(), eq(variables['SetExecutableBit'], 'true'))
            workingDirectory: cli/azd
            displayName: Set executable bit for non-Windows binaries

          - template: /eng/pipelines/templates/steps/build-linux-packages.yml
            parameters:
              Condition: and(succeeded(), eq(variables['BuildLinuxPackages'], 'true'))

          - task: PowerShell@2
            condition: and(succeeded(), eq(variables['SetShieldInfo'], 'true'))
            inputs:
              pwsh: true
              targetType: filePath
              filePath: eng/scripts/Set-ShieldInfo.ps1
              arguments: >-
                -TemplatePath eng/shields/standalone.json
                -Version "$(CLI_VERSION)"
            displayName: Set shield info

          - publish: cli/azd/cover-$(AZURE_DEV_CI_OS)
            artifact: cover-$(AZURE_DEV_CI_OS)
            displayName: Upload code coverage

          - publish: eng/shields/standalone.json
            condition: and(succeeded(), eq(variables['SetShieldInfo'], 'true'))
            artifact: shield-standalone
            displayName: Upload standalone shield json

          - publish: cli/azd/$(BuildTarget)
            artifact: $(BuildTarget)
            condition: always()
            displayName: Upload azd binary to artifact store

          - publish: cli/installer/windows/bin/Release
            artifact: test-msi
            condition: and(succeeded(), eq(variables['BuildTestMsi'], 'true'))
            displayName: Upload test MSI

          - publish: cli/installer/fpm/artifact
            artifact: linux-packages
            condition: and(succeeded(), eq(variables['BuildLinuxPackages'], 'true'))
            displayName: Upload linux packages to artifact store

      # This is separated today because Skip.LiveTest is a queue-time variable
      # and cannot be set in a matrix entry. 
      - job: CrossBuildCLI
        strategy: 
          matrix: 
            LinuxARM64: 
              Pool: azsdk-pool-mms-ubuntu-2004-general
              OSVmImage:  MMSUbuntu20.04
              BuildTarget: azd-linux-arm64
              BuildOutputName: azd
              SetExecutableBit: true
              GOOS: linux
              GOARCH: arm64
            MacARM64:
              Pool: Azure Pipelines
              OSVmImage: macOS-11
              BuildTarget: azd-darwin-arm64
              BuildOutputName: azd
              SetExecutableBit: true
              GOOS: darwin
              GOARCH: arm64
              # CGO_ENABLED is required on MacOS to cross-compile pkg/outil/osversion
              CGO_ENABLED: 1
        pool: 
          name: $(Pool)
          vmImage: $(OSVmImage)
        timeoutInMinutes: 20
        steps: 
          - checkout: self

          - template: /eng/pipelines/templates/steps/setup-go.yml
            parameters:
              Condition: false

          - template: /eng/pipelines/templates/steps/set-cli-version-cd.yml

          - task: PowerShell@2
            inputs:
              pwsh: true
              targetType: filePath
              filePath: eng/scripts/Set-CliVersionVariable.ps1
            displayName: Set CLI_VERSION

          - task: PowerShell@2
            inputs:
              pwsh: true
              targetType: filePath
              filePath: cli/azd/ci-build.ps1
              arguments: >-
                -Version $(CLI_VERSION)
                -SourceVersion $(Build.SourceVersion)
              workingDirectory: cli/azd
            displayName: Build Go Binary (cross compile)

          - pwsh: file azd
            workingDirectory: cli/azd
            displayName: Get file info

          - pwsh: Move-Item $(BuildOutputName) $(BuildTarget)
            workingDirectory: cli/azd
            displayName: Rename binaries

          - bash: chmod +x $(BuildTarget)
            condition: and(succeeded(), eq(variables['SetExecutableBit'], 'true'))
            workingDirectory: cli/azd
            displayName: Set executable bit for non-Windows binaries

          - publish: cli/azd/$(BuildTarget)
            artifact: $(BuildTarget)
            condition: always()
            displayName: Upload azd binary to artifact store

      - job: ValidateCrossCompile
        dependsOn: CrossBuildCLI
        pool: 
          name: azsdk-pool-mms-ubuntu-2004-arm
          vmImage: MMSUbuntu20.04ARM64
        timeoutInMinutes: 5
        steps: 
          - checkout: none 

          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: azd-linux-arm64
              targetPath: $(Build.SourcesDirectory)

          - bash: pwd && ls && chmod +x ./azd-linux-arm64 && ./azd-linux-arm64 version
            displayName: azd version

      - job: GenerateReleaseArtifacts
        pool:
          name: azsdk-pool-mms-ubuntu-2004-general
          vmImage: MMSUbuntu20.04

        steps:
          - checkout: self

          - template: /eng/pipelines/templates/steps/setup-go.yml

          # Install scripts
          - pwsh: |
              New-Item -ItemType Directory -Path installer
              Copy-Item cli/installer/*install-azd.ps1 installer/
            displayName: Copy installer scripts (*.ps1) for artifact upload

          - task: PublishPipelineArtifact@1
            displayName: Publish install scripts to artifacts for signing
            inputs:
              artifactName: install-pwsh
              targetPath: installer

          # CLI ref docs
          - pwsh: New-Item -ItemType Directory -Path docs
            workingDirectory: $(Pipeline.Workspace)
            displayName: Create docs artifact folder

          - pwsh: go run docgen.go
            workingDirectory: cli/azd/docs
            displayName: Generate CLI documentation

          - pwsh: Copy-Item $(Build.SourcesDirectory)/cli/azd/docs/md/* docs/ -Recurse
            workingDirectory: $(Pipeline.Workspace)
            displayName: Copy CLI docs for pipeline artifact staging

          # azure.yaml.json schema docs
          - task: UsePythonVersion@0
            inputs:
              versionSpec: 3.x

          - pwsh: pip install jsonschema2md
            displayName: Install jsonschema2md

          - pwsh: jsonschema2md schemas/v1.0/azure.yaml.json $(Pipeline.Workspace)/docs/azure.yaml.schema.md
            displayName: Generate azure.yaml schema

          # Upload docs for CLI ref and azure.yaml schema
          - pwsh: Get-ChildItem .
            workingDirectory: $(Pipeline.Workspace)/docs
            displayName: Show doc artifacts to publish

          - publish: $(Pipeline.Workspace)/docs/
            artifact: docs
            displayName: Upload generated documentation

  - stage: CodeCoverage_Upload
    dependsOn: BuildAndTest
    jobs:
    - job: Upload
      pool:
        name: azsdk-pool-mms-ubuntu-2004-general
        vmImage: MMSUbuntu20.04
      steps:
        - template: /eng/pipelines/templates/steps/setup-go.yml
        - template: /eng/pipelines/templates/steps/download-artifacts.yml
          parameters:
            Artifacts:
            - cover-win
            - cover-lin
            - cover-mac
        - pwsh: |
            New-Item -ItemType Directory -Force -Path cover
            New-Item -ItemType Directory -Force -Path cover-int
            New-Item -ItemType Directory -Force -Path cover-unit

            $unitCoverage = (Get-ChildItem cover-*/unit).FullName -join ","
            $integrationCoverage = (Get-ChildItem cover-*/int).FullName -join ","

            # Merge unit test coverage across platforms
            go tool covdata merge -i="$unitCoverage" -o cover-unit
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

            # Merge integration test coverage across platforms
            go tool covdata merge -i="$integrationCoverage" -o cover-int
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

            # Merge unit and integration code coverage
            go tool covdata merge -i="cover-unit,cover-int" -o cover
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

            # Convert to text format
            go tool covdata textfmt -i=cover -o cover.out
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

            go install github.com/axw/gocov/gocov@latest
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
            go install github.com/AlekSi/gocov-xml@latest
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
            
            ~/go/bin/gocov convert cover.out | ~/go/bin/gocov-xml > coverage.xml
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          displayName: Merge code coverage files

        - publish: cover-unit
          artifact: cover-unit
          displayName: Upload unit test code coverage

        - publish: cover-int
          artifact: cover-int
          displayName: Upload integration test code coverage

        - task: PublishCodeCoverageResults@1
          inputs:
            codeCoverageTool: Cobertura
            summaryFileLocation: '$(Build.SourcesDirectory)/**/coverage.xml'
          displayName: Publish Code Coverage to DevOps

  - stage: Sign
    dependsOn: BuildAndTest
    jobs:

    - job: SignMac
      pool:
        name: azsdk-pool-mms-win-2022-general
        vmImage: MMS2022

      steps:
        - task: DownloadPipelineArtifact@2
          inputs:
            artifact: azd-darwin-amd64
            path: mac-artifacts

        - task: DownloadPipelineArtifact@2
          inputs:
            artifact: azd-darwin-arm64
            path: mac-artifacts

        - pwsh: |
            New-Item -ItemType Directory -Path mac
            
            Compress-Archive `
            -Path mac-artifacts/azd-darwin-amd64 `
            -DestinationPath mac/azd-darwin-amd64.zip

            Compress-Archive `
            -Path mac-artifacts/azd-darwin-arm64 `
            -DestinationPath mac/azd-darwin-arm64.zip
          displayName: Package mac binary for signing

        - ${{ if in(variables['Build.Reason'], 'IndividualCI', 'BatchedCI', 'Manual') }}:
          - template: pipelines/steps/azd-cli-mac-signing.yml@azure-sdk-build-tools
            parameters:
              MacPath: mac

        - ${{ else }}:
          - pwsh: Write-Host "Skipping signing. Build reason - $(Build.Reason)"
            displayName: Signing process skipped for non-release build

        - pwsh: |
            Expand-Archive -Path mac/azd-darwin-amd64.zip -DestinationPath mac/
            Expand-Archive -Path mac/azd-darwin-arm64.zip -DestinationPath mac/

            Remove-Item mac/azd-darwin-amd64.zip
            Remove-Item mac/azd-darwin-arm64.zip
          displayName: Extract azd-darwin-amd64 from zip and remove zip

        - pwsh: |
            New-Item -ItemType Directory -Path signed-mac
            Copy-Item mac/* signed-mac/ -Recurse
          displayName: Copy signing outputs
          condition: always()

        # TODO: Replace with https://github.com/Azure/azure-sdk-tools/blob/main/eng/common/pipelines/templates/steps/publish-artifact.yml
        # when the common engsys is imported.
        # https://github.com/Azure/azure-dev/issues/956
        - task: PublishPipelineArtifact@1
          condition: succeeded()
          displayName: Publish Signed Artifacts
          inputs:
            artifactName: signed-mac
            path: signed-mac/

        - task: PublishPipelineArtifact@1
          condition: failed()
          displayName: Publish failed Signed Artifacts
          inputs:
            artifactName: signed-mac-FailedAttempt$(System.JobAttempt)
            path: signed-mac/

    - job: SignWindows
      pool:
        name: azsdk-pool-mms-win-2022-general
        vmImage: MMS2022

      steps:
        # Checkout required to build MSI
        - checkout: self

        - task: DownloadPipelineArtifact@2
          inputs:
            artifact: azd-windows-amd64.exe
            path: win

        - task: DownloadPipelineArtifact@2
          inputs:
            artifact: install-pwsh
            path: installer

        - pwsh: Copy-Item installer/*.ps1 win
          displayName: Copy install scripts to win/

        - ${{ if in(variables['Build.Reason'], 'IndividualCI', 'BatchedCI', 'Manual') }}:
          - template: pipelines/steps/azd-cli-win-signing.yml@azure-sdk-build-tools
            parameters:
              WinPath:  win
              WinPattern: '**'

        - ${{ else }}:
          - pwsh: Write-Host "Skipping signing. Build reason - $(Build.Reason)"
            displayName: Signing process skipped for non-release build

        - pwsh: |
            New-Item -ItemType Directory -Path signed-win
            Copy-Item win/* signed-win/ -Recurse
            Copy-Item win/azd-windows-amd64.exe cli/azd/azd.exe
          displayName: Copy signing outputs for publishing and MSI build
          condition: always()

        - task: PowerShell@2
          inputs:
            pwsh: true
            targetType: filePath
            filePath: eng/scripts/Set-CliVersionVariable.ps1
          displayName: Set CLI_VERSION for MSI build

        - template: /eng/pipelines/templates/steps/build-msi.yml
          parameters:
            Title: Build Release MSI

        - ${{ if in(variables['Build.Reason'], 'IndividualCI', 'BatchedCI', 'Manual') }}:
          - template: pipelines/steps/azd-cli-win-signing.yml@azure-sdk-build-tools
            parameters:
              WinPath:  cli/installer/windows/bin/Release
              WinPattern: '*.msi'

        - ${{ else }}:
          - pwsh: Write-Host "Skipping signing. Build reason - $(Build.Reason)"
            displayName: Signing process skipped for non-release build

        - pwsh: Copy-Item cli/installer/windows/bin/Release/* signed-win/
          displayName: Copy MSI for publishing

        # TODO: Replace with https://github.com/Azure/azure-sdk-tools/blob/main/eng/common/pipelines/templates/steps/publish-artifact.yml
        # when the common engsys is imported.
        # https://github.com/Azure/azure-dev/issues/956
        - task: PublishPipelineArtifact@1
          condition: succeeded()
          displayName: Publish Signed Artifacts
          inputs:
            artifactName: signed-win
            path: signed-win/

        - task: PublishPipelineArtifact@1
          condition: failed()
          displayName: Publish failed Signed Artifacts
          inputs:
            artifactName: signed-win-FailedAttempt$(System.JobAttempt)
            path: signed-win/

    - job: SignLinux
      pool:
        name: azsdk-pool-mms-win-2022-general
        vmImage: MMS2022

      steps:
        - task: DownloadPipelineArtifact@2
          inputs:
            artifact: linux-packages
            path: linux

        - ${{ if in(variables['Build.Reason'], 'IndividualCI', 'BatchedCI', 'Manual') }}:
          - template: pipelines/steps/azd-cli-linux-signing.yml@azure-sdk-build-tools
            parameters:
              LinuxPath: linux

        - ${{ else }}:
          - pwsh: Write-Host "Skipping signing. Build reason - $(Build.Reason)"
            displayName: Signing process skipped for non-release build

        - pwsh: |
            New-Item -ItemType Directory -Path signed-linux
            Copy-Item linux/* signed-linux/ -Recurse
          displayName: Copy signing outputs
          condition: always()

        - task: PublishPipelineArtifact@1
          condition: succeeded()
          displayName: Publish Signed Artifacts
          inputs:
            artifactName: signed-linux
            path: signed-linux/

        - task: PublishPipelineArtifact@1
          condition: failed()
          displayName: Publish failed Signed Artifacts
          inputs:
            artifactName: signed-linux-FailedAttempt$(System.JobAttempt)
            path: signed-linux/
      

  - stage: Verify_Installers
    condition: and(succeeded(), ne(variables['Skip.VerifyInstallers'], 'true'))
    dependsOn: BuildAndTest
    jobs:
      - job: Compress_For_Hosting
        pool:
          name: azsdk-pool-mms-ubuntu-2004-general
          vmImage: MMSUbuntu20.04

        steps:
          - checkout: self

          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: azd-windows-amd64.exe
              path: azd-windows-amd64.exe

          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: azd-linux-amd64
              path: azd-linux-amd64

          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: azd-darwin-amd64
              path: azd-darwin-amd64

          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: test-msi
              path: msi

          - pwsh: |
              Write-Host "Moving downloaded files to hosting folder"
              New-Item -ItemType Directory -Path hosting

              Write-Host "Compressing artifacts as if publishing"
              zip hosting/azd-windows-amd64.zip -j azd-windows-amd64.exe/azd-windows-amd64.exe

              chmod +x azd-darwin-amd64/azd-darwin-amd64
              zip hosting/azd-darwin-amd64.zip -j azd-darwin-amd64/azd-darwin-amd64

              chmod +x azd-linux-amd64/azd-linux-amd64
              tar -C azd-linux-amd64 -cvzf hosting/azd-linux-amd64.tar.gz azd-linux-amd64

              Copy-Item msi/azd-windows-amd64.msi hosting/

              Copy-Item cli/installer/*stall-azd.* hosting/

              Get-ChildItem hosting/ -Recurse | Select-Object -Property Name,Size
            displayName: Move folders to hosting location

          - publish: hosting
            artifact: test-hosting

      - job: Verify_MSI
        dependsOn: Compress_For_Hosting
        pool: azsdk-pool-mms-win-2022-general
        variables: 
          AZURE_DEV_COLLECT_TELEMETRY: no
        strategy:
          matrix:
            PerUser:
              PerMachine: $false
            AllUsers:
              PerMachine: $true
        steps:
          - checkout: self

          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: test-msi
              path: msi

          - task: PowerShell@2
            inputs:
              pwsh: true
              targetType: filePath
              filePath: cli/installer/windows/test-win-msi.ps1
              arguments: >-
                -PerMachine:$(PerMachine)
                -MsiPath msi/azd-windows-amd64.msi
              # Do not exit on first Write-Error, write all messages and let the
              # script handle exiting with an error status.
              errorActionPreference: continue
            displayName: Test MSI

      - job: Verify_Mac_InstallOver
        dependsOn: Compress_For_Hosting
        pool:
          name: Azure Pipelines
          vmImage: macOS-12

        steps:
          - checkout: self

          - bash: ./install-azd.sh --version daily --verbose
            displayName: Install "daily" version
            workingDirectory: cli/installer/

          - pwsh: azd version
            displayName: Run azd version

          - bash: ./install-azd.sh --version latest --verbose
            displayName: Install "latest" version
            workingDirectory: cli/installer/

          - pwsh: azd version
            displayName: Run azd version (expect no failure)

      - job: Verify_Installers
        dependsOn: Compress_For_Hosting
        strategy:
          matrix:
            LinuxDockerSh:
              Pool: azsdk-pool-mms-ubuntu-2004-general
              OSVmImage:  MMSUbuntu20.04
              TestShell: pwsh
              TestInstallCommand: >
                ./test-installer-containers.ps1
                -BaseUrl "http://host.docker.internal:8080"
                -Version ''
                -ContainerPrefix '$(docker-mirror-tag-prefix)/'
                -AdditionalRunArgs '--add-host=host.docker.internal:host-gateway'
            LinuxSh:
              Pool: azsdk-pool-mms-ubuntu-2004-general
              OSVmImage:  MMSUbuntu20.04
              TestShell: bash
              TestInstallCommand: >
                ./test-sh-install.sh "bash" "$BASEURL" "" &&
                ./test-telemetry-functions.sh "telemetry/linux.sh.telemetry.csv" &&
                ./test-sh-install-errors.sh "bash" "$BASEURL" ""
            LinuxPwsh:
              Pool: azsdk-pool-mms-ubuntu-2004-general
              OSVmImage:  MMSUbuntu20.04
              TestShell: pwsh
              TestInstallCommand: >
                ./test-pwsh-xplat-install.ps1 
                -BaseUrl $env:BASEURL 
                -Version '' 
                -InstallShScriptUrl "$($env:BASEURL)/install-azd.sh"
                -UninstallShScriptUrl "$($env:BASEURL)/uninstall-azd.sh";
                ./test-telemetry-functions.ps1 -NonInteractive -Shell pwsh -ExpectedFieldMap telemetry/linux.telemetry.json

            Mac11Sh:
              Pool: Azure Pipelines
              OSVmImage: macOS-11
              TestShell: bash
              TestInstallCommand: >
                ./test-sh-install.sh "bash" "$BASEURL" "" &&
                ./test-telemetry-functions.sh "telemetry/macos11.sh.telemetry.csv" &&
                ./test-sh-install-errors.sh "bash" "$BASEURL" ""
            Mac12Sh:
              Pool: Azure Pipelines
              OSVmImage: macOS-12
              TestShell: bash
              TestInstallCommand: >
                ./test-sh-install.sh "bash" "$BASEURL" "" &&
                ./test-telemetry-functions.sh "telemetry/macos12.sh.telemetry.csv" &&
                ./test-sh-install-errors.sh "bash" "$BASEURL" ""
            Mac12Pwsh:
              Pool: Azure Pipelines
              OSVmImage: macOS-12
              TestShell: pwsh
              # Should also test telemetry functions but cannot because of macOS
              # host limitations in DevOps which do not reproduce on non-DevOps
              # macs. Disabled for now.
              #  ./test-telemetry-functions.ps1 -Shell pwsh -ExpectedFieldMap telemetry/macos.telemetry.json
              TestInstallCommand: >
                ./test-pwsh-xplat-install.ps1 
                -BaseUrl $env:BASEURL 
                -Version '' 
                -InstallShScriptUrl "$($env:BASEURL)/install-azd.sh"
                -UninstallShScriptUrl "$($env:BASEURL)/uninstall-azd.sh"
            Mac11Pwsh:
              Pool: Azure Pipelines
              OSVmImage: macOS-11
              TestShell: pwsh
              # Should also test telemetry functions but cannot because of macOS
              # host limitations in DevOps which do not reproduce on non-DevOps
              # macs. Disabled for now.
              #  ./test-telemetry-functions.ps1 -Shell pwsh -ExpectedFieldMap telemetry/macos.telemetry.json
              TestInstallCommand: >
                ./test-pwsh-xplat-install.ps1 
                -BaseUrl $env:BASEURL 
                -Version '' 
                -InstallShScriptUrl "$($env:BASEURL)/install-azd.sh"
                -UninstallShScriptUrl "$($env:BASEURL)/uninstall-azd.sh"
            WindowsCmd:
              Pool: azsdk-pool-mms-win-2022-general
              OSVmImage: MMS2022
              TestShell: cmd
              TestInstallCommand: cmd /c test-windows-install.cmd %BASEURL%
            WindowsPwsh:
              Pool: azsdk-pool-mms-win-2022-general
              OSVmImage: MMS2022
              TestShell: pwsh
              TestInstallCommand: >
                $ErrorActionPreference = 'Stop';
                ./test-win-install.ps1 -BaseUrl $env:BASEURL -Version '';
                ./test-telemetry-functions.ps1 -Shell pwsh -ExpectedFieldMap telemetry/windows.pwsh.telemetry.json
            WindowsPowerShell:
              Pool: azsdk-pool-mms-win-2022-general
              OSVmImage: MMS2022
              TestShell: powershell
              TestInstallCommand: >
                $ErrorActionPreference = 'Stop';
                ./test-win-install.ps1 -BaseUrl $env:BASEURL -Version '';
                ./test-telemetry-functions.ps1 -Shell powershell -ExpectedFieldMap telemetry/windows.powershell.telemetry.json

        pool:
          name: $(Pool)
          vmImage: $(OSVmImage)

        variables:
          BaseUrl: http://127.0.0.1:8080

        timeoutInMinutes: 10

        steps:
          - checkout: self

          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: test-hosting
              path: hosting

          - bash: ls
            workingDirectory: hosting

          - bash: |
              unzip ./azd-darwin-amd64.zip -d ./tmp

              # Ad-hoc signing with "-" identity
              codesign -s - tmp/azd-darwin-amd64

              zip azd-darwin-amd64.zip -j tmp/azd-darwin-amd64
            displayName: Self-sign (Darwin)
            condition: and(succeeded(), contains(variables['Agent.OS'], 'Darwin'))
            workingDirectory: hosting

          - pwsh: |
              $ErrorActionPreference = 'Stop'

              # Generate self-sign cert
              $cert = New-SelfSignedCertificate -CertStoreLocation Cert:\LocalMachine\My -Type CodeSigningCert -Subject "azd installer tests code signing"
              
              # Add as temporary trusted root CA
              try {
                Export-Certificate -Cert $cert -FilePath code_signing.crt
                Import-Certificate -FilePath .\code_signing.crt -Cert Cert:\LocalMachine\Root
              }
              finally {
                Remove-Item -Force .\code_signing.crt -ErrorAction SilentlyContinue
              }

              # Sign the windows binary
              Set-AuthenticodeSignature .\azd-windows-amd64.msi -Certificate $cert
            displayName: Self-sign (Windows)
            condition: and(succeeded(), contains(variables['Agent.OS'], 'Windows'))
            workingDirectory: hosting

          - bash: nohup npx -y http-server &
            displayName: Start server in hosting/ (bash)
            condition: and(succeeded(), not(contains(variables['Agent.OS'], 'Windows')))
            workingDirectory: hosting

          - pwsh: |
              Start-Process npx.cmd `
                -ArgumentList @('-y', 'http-server') `
                -NoNewWindow `
                -PassThru `
                -RedirectStandardOutput ../server.log
              Write-Host "Server started, waiting for server to initialize"
              Start-Sleep -Seconds 15
            displayName: Start server in hosting/ (pwsh)
            condition: and(succeeded(), contains(variables['Agent.OS'], 'Windows'))
            workingDirectory: hosting

          - pwsh: |
              $tmpFile = New-TemporaryFile
              $timer = [Diagnostics.Stopwatch]::StartNew()
              $MAX_ELAPSED_SECONDS = 120
              $TIMEOUT_SECONDS = 12
              $SLEEP_SECONDS = 1

              while ($timer.Elapsed.TotalSeconds -lt $MAX_ELAPSED_SECONDS) {
                try {
                  Write-Host "Downloading file..."
                  Invoke-WebRequest `
                    $(BaseUrl)/azd-windows-amd64.zip `
                    -OutFile $tmpFile `
                    -TimeoutSec $TIMEOUT_SECONDS

                  if ($LASTEXITCODE) {
                    throw "Failed downloading file"
                  }
                } catch {
                  Write-Host "Error downloading file."
                  Write-Host $_
                  Start-Sleep -Seconds $SLEEP_SECONDS
                  continue
                }

                # Exit if the downloaded file size is less than a small threshold
                # this could mean an error in how the files are being served.
                if ((Get-Item $tmpFile).Length -le 100000) {
                  Get-Content $tmpFile
                  exit 1
                }

                break
              }

              Get-Item $tmpFile | Select-Object -Property Name,Length
            displayName: Verify installer hosting

          - pwsh: $(TestInstallCommand)
            condition: and(succeeded(), eq('pwsh', variables['TestShell']))
            workingDirectory: cli/installer/
            displayName: Test install script (pwsh)

          - powershell: $(TestInstallCommand)
            condition: and(succeeded(), eq('powershell', variables['TestShell']))
            workingDirectory: cli/installer/
            displayName: Test install script (PowerShell)

          - bash: $(TestInstallCommand)
            condition: and(succeeded(), eq('bash', variables['TestShell']))
            workingDirectory: cli/installer/
            displayName: Test install script (bash)

          - task: CmdLine@2
            condition: and(succeeded(), eq('cmd', variables['TestShell']))
            inputs:
              script: $(TestInstallCommand)
              workingDirectory: cli/installer/
            displayName: Test install script (cmd)

          - pwsh: |
              Get-ChildItem Cert:\LocalMachine\My | ForEach-Object {
                if ($_.Subject -match "azd installer tests code signing") {
                  Write-Host "Deleting $($_.PSPath) - $($_.Subject)"
                  Remove-Item -Force $_.PSPath
                }
              }

              Get-ChildItem Cert:\LocalMachine\Root | ForEach-Object {
                if ($_.Subject -match "azd installer tests code signing") {
                  Write-Host "Deleting $($_.PSPath) - $($_.Subject)"
                  Remove-Item -Force $_.PSPath
                }
              }
            displayName: Clean up self-signed certificates (Windows)
            condition: contains(variables['Agent.OS'], 'Windows')
            workingDirectory: hosting

      - job: Verify_LinuxPackages

        pool:
          name: azsdk-pool-mms-ubuntu-2004-general

        steps: 
          - checkout: self

          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: linux-packages
              path: cli/installer/fpm

          - task: PowerShell@2
            displayName: Verify Linux Packages
            inputs: 
              pwsh: true
              workingDirectory: cli/installer/fpm
              filePath: eng/scripts/Test-LinuxPackages.ps1


  - stage: PublishCLI
    dependsOn: Sign
    condition: >-
      and(
        succeeded(),
        ne(variables['Skip.Release'], 'true'),
        or(
          eq('Manual', variables['BuildReasonOverride']),
          and(
            eq('', variables['BuildReasonOverride']),
            eq('Manual', variables['Build.Reason'])
          )
        )
      )
    jobs:
      - deployment: Publish_Release
        condition: >-
          and(
            succeeded(),
            ne('true', variables['Skip.Publish'])
          )
        environment: azure-dev

        pool:
          name: azsdk-pool-mms-ubuntu-2004-general
          OSVmImage: MMSUbuntu20.04

        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - task: PowerShell@2
                  inputs:
                    pwsh: true
                    targetType: filePath
                    filePath: eng/scripts/Set-CliVersionVariable.ps1
                  displayName: Set CLI_VERSION

                - pwsh: |
                    # Initial upload locations
                    $publishUploadLocations = 'release/$(CLI_VERSION);release/latest'

                    $isPublishingGa = eng/scripts/Test-ShouldReleasePackageVersion.ps1 `
                      -CliVersion '$(CLI_VERSION)'

                    if ($isPublishingGa) {
                      $publishUploadLocations += ";release/stable"
                    }

                    Write-Host "Setting StorageUploadLocations to $publishUploadLocations"
                    Write-Host "###vso[task.setvariable variable=StorageUploadLocations]$publishUploadLocations"
                  displayName: Set StorageUploadLocations

                - pwsh: |
                    # Initial tag
                    $dockerTags = '$(CLI_VERSION)'

                    $isPublishingGa = eng/scripts/Test-ShouldReleasePackageVersion.ps1 `
                      -CliVersion '$(CLI_VERSION)'

                    if ($isPublishingGa) {
                      $dockerTags += ";latest"
                    }

                    Write-Host "Setting DockerImageTags to $dockerTags"
                    Write-Host "###vso[task.setvariable variable=DockerImageTags]$dockerTags"
                  displayName: Set DockerImageTags

                - template: /eng/pipelines/templates/steps/publish-cli.yml
                  parameters:
                    CreateGitHubRelease: true
                    PublishUploadLocations: $(StorageUploadLocations)
                    PublishShield: true
                    DockerImageTags: $(DockerImageTags)
                    ReleaseSyndicatedDockerContainer: true
                    PublishUpdatedDocs: true
                    UploadMsi: true
                    PublishBrewFormula: true
                    PublishArm64Binaries: true

      - deployment: Publish_Choco
        dependsOn: Publish_Release
        condition: >-
          and(
            succeeded(),
            ne('true', variables['Skip.Publish'])
          )
        environment: azure-dev

        pool:
          name: azsdk-pool-mms-win-2022-general

        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - task: PowerShell@2
                  inputs:
                    pwsh: true
                    targetType: filePath
                    filePath: eng/scripts/Set-CliVersionVariable.ps1
                  displayName: Set CLI_VERSION

                - template: /eng/pipelines/templates/steps/publish-cli-choco.yml
                  parameters:
                    CliVersion: $(CLI_VERSION)

      - deployment: Publish_WinGet
        dependsOn: Publish_Release
        condition: >-
          and(
            succeeded(),
            ne('true', variables['Skip.Publish'])
          )
        environment: azure-dev

        pool:
          name: azsdk-pool-mms-win-2022-general

        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - task: PowerShell@2
                  inputs:
                    pwsh: true
                    targetType: filePath
                    filePath: eng/scripts/Set-CliVersionVariable.ps1
                  displayName: Set CLI_VERSION

                - template: /eng/pipelines/templates/steps/publish-cli-winget.yml
                  parameters:
                    CliVersion: $(CLI_VERSION)

      - deployment: Increment_Version
        condition: >-
          and(
            succeeded(),
            ne('true', variables['Skip.IncrementVersion'])
          )
        dependsOn: Publish_Release
        environment: azure-dev

        pool:
          name: azsdk-pool-mms-ubuntu-2004-general
          OSVmImage: MMSUbuntu20.04

        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: PowerShell@2
                  inputs:
                    pwsh: true
                    targetType: filePath
                    filePath: eng/scripts/Update-CliVersion.ps1
                  displayName: Increment CLI version

                - template: /eng/common/pipelines/templates/steps/create-pull-request.yml
                  parameters:
                    PRBranchName: cli-version-increment-$(Build.BuildId)
                    CommitMsg: Increment CLI version after release
                    PRTitle: Increment CLI version after release

  - stage: Publish_Integration
    dependsOn: Sign
    jobs:
      - job: Publish_Continuous_Deployment
        condition: >-
          and(
            succeeded(),
            ne(variables['Skip.Release'], 'true'),
            or(
              in(variables['BuildReasonOverride'], 'IndividualCI', 'BatchedCI'),
              and(
                eq('', variables['BuildReasonOverride']),
                in(variables['Build.Reason'], 'IndividualCI', 'BatchedCI')
              )
            )
          )
        pool:
          name: azsdk-pool-mms-ubuntu-2004-general
          OSVmImage: MMSUbuntu20.04

        steps:
          - checkout: self
          - template: /eng/pipelines/templates/steps/set-cli-version-cd.yml

          - task: PowerShell@2
            inputs:
              pwsh: true
              targetType: filePath
              filePath: eng/scripts/Set-CliVersionVariable.ps1
            displayName: Set CLI_VERSION

          - template: /eng/pipelines/templates/steps/publish-cli.yml
            parameters:
              CreateGitHubRelease: false
              PublishUploadLocations: release/daily;daily/archive/$(Build.BuildId)-$(Build.SourceVersion)
              PublishShield: false
              DockerImageTags: daily;$(CLI_VERSION)
              UploadMsi: true
              PublishArm64Binaries: true

      - job: Publish_For_PR
        condition: >-
          and(
            succeeded(),
            ne(variables['Skip.Release'], 'true'),
            or(
              eq('PullRequest', variables['BuildReasonOverride']),
              and(
                eq('', variables['BuildReasonOverride']),
                eq(variables['Build.Reason'], 'PullRequest')
              )
            )
          )
        pool:
          name: azsdk-pool-mms-ubuntu-2004-general
          OSVmImage: MMSUbuntu20.04

        steps:
          - checkout: self
          - pwsh: |
              $PRNumber = "$(System.PullRequest.PullRequestNumber)"
              if ($env:PRNUMBEROVERRIDE) {
                Write-Host "PR Number override: $($env:PRNUMBEROVERRIDE)"
                $PRNumber = "$($env:PRNUMBEROVERRIDE)"
              }
              Write-Host "##vso[task.setvariable variable=PRNumber]$PRNumber"
            displayName: Set PR Number Variable

          - task: PowerShell@2
            inputs:
              pwsh: true
              targetType: filePath
              filePath: eng/scripts/Set-CliVersionVariable.ps1
            displayName: Set CLI_VERSION

          - template: /eng/pipelines/templates/steps/publish-cli.yml
            parameters:
              CreateGitHubRelease: false
              PublishUploadLocations: pr/$(PRNumber)
              UploadInstaller: true
              DockerImageTags: pr-$(PRNumber)
              UploadMsi: true
              PublishArm64Binaries: true

          - pwsh: |
              $urlBase = "https://$(azdev-storage-account-name).blob.core.windows.net/azd/standalone/pr/$(PRNumber)"
              Write-Host "##vso[task.setvariable variable=UrlBase;isOutput=true]$urlBase"
            name: GenerateUrlBase
            displayName: Set UrlBase

          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: docs
              path: docs

          - pwsh: |
              $urlBase = "$(GenerateUrlBase.UrlBase)"
              $linuxReleaseUrl = "$urlBase/azd-linux-amd64.tar.gz"
              $linuxReleaseUrlArm64 = "$urlBase/azd-linux-arm64-beta.tar.gz"
              $macosReleaseUrl = "$urlBase/azd-darwin-amd64.zip"
              $macosReleaseUrlArm64 = "$urlBase/azd-darwin-arm64-beta.zip"
              $windowsReleaseUrl = "$urlBase/azd-windows-amd64.zip"
              $msiReleaseUrl = "$urlBase/azd-windows-amd64.msi"

              $refDocContent = Get-Content docs/azd.md -Raw

              $content = @"
              <!-- #comment-cli-pr -->
              ## Azure Dev CLI Install Instructions

              ### Install scripts

              #### MacOS/Linux

              > May elevate using ``sudo`` on some platforms and configurations

              bash:
              ``````
              curl -fsSL $urlBase/uninstall-azd.sh | bash;
              curl -fsSL $urlBase/install-azd.sh | bash -s -- --base-url $urlBase --version '' --verbose --skip-verify
              ``````

              pwsh:
              ``````
              Invoke-RestMethod '$urlBase/uninstall-azd.ps1' -OutFile uninstall-azd.ps1; ./uninstall-azd.ps1
              Invoke-RestMethod '$urlBase/install-azd.ps1' -OutFile install-azd.ps1; ./install-azd.ps1 -BaseUrl '$urlBase' -Version '' -SkipVerify -Verbose
              ``````


              #### Windows

              PowerShell install

              ``````
              powershell -c "Set-ExecutionPolicy Bypass Process; irm '$urlBase/uninstall-azd.ps1' > uninstall-azd.ps1; ./uninstall-azd.ps1;"
              powershell -c "Set-ExecutionPolicy Bypass Process; irm '$urlBase/install-azd.ps1' > install-azd.ps1; ./install-azd.ps1 -BaseUrl '$urlBase' -Version '' -SkipVerify -Verbose;"
              ``````

              MSI install
              ``````
              powershell -c "irm '$msiReleaseUrl' -OutFile azd-windows-amd64.msi; msiexec /i azd-windows-amd64.msi /qn"
              ``````

              ### Standalone Binary

              * Linux - 
                  * x86_64 - $linuxReleaseUrl
                  * ARM64 - $linuxReleaseUrlArm64
              * MacOS - 
                  * x86_64 - $macosReleaseUrl
                  * ARM64 - $macosReleaseUrlArm64
              * Windows - $windowsReleaseUrl

              ### MSI

              * $msiReleaseUrl

              ### Container

              ``````
              docker run -it $(azdev-acr-host)/azure-dev:pr-$(PRNumber)
              ``````

              ## Documentation

              <details>
              <summary>learn.microsoft.com documentation</summary>

              $refDocContent

              </details>
              "@
              $file = New-TemporaryFile
              Set-Content -Path $file -Value $content
              Write-Host "##vso[task.setvariable variable=CommentBodyFile]$file"
            displayName: Write body content to temporary file

          - task: PowerShell@2
            displayName: Add PR comment
            inputs:
              pwsh: true
              targetType: filePath
              filePath: ./eng/scripts/Update-PRComment.ps1
              arguments: >-
                -Repo "$(Build.Repository.Name)"
                -PrNumber $(PRNumber)
                -Tag "<!-- #comment-cli-pr -->"
                -BodyFile $(CommentBodyFile)
            env:
              GH_TOKEN: $(azuresdk-github-pat)

  - stage: PublishInstallers
    dependsOn: Sign
    condition: >-
      and(
        succeeded(),
        ne(variables['Skip.Release'], 'true'),
        or(
          eq('Manual', variables['BuildReasonOverride']),
          and(
            eq('', variables['BuildReasonOverride']),
            eq('Manual', variables['Build.Reason'])
          )
        )
      )
    jobs:
      - deployment: PublishInstallers
        environment: azure-dev
        pool:
          name: azsdk-pool-mms-ubuntu-2004-general
          OSVmImage: MMSUbuntu20.04

        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: DownloadPipelineArtifact@2
                  inputs:
                    artifact: signed-win
                    path: signed-win

                - pwsh: |
                    New-Item -ItemType Directory -Path script-release
                    Copy-Item signed-win/*.ps1 script-release/
                    Copy-Item cli/installer/*.sh script-release/
                  displayName: Copy scripts for release upload

                - pwsh: |
                    az storage blob upload-batch `
                      --account-name '$(azdev-storage-account-name)' `
                      --account-key '$(azdev-storage-account-key)' `
                      --auth-mode key `
                      -s script-release/ `
                      -d "azd/standalone/installer" `
                      --overwrite
                  displayName: Upload installer to storage location
