trigger:
  branches:
    include:
      - cse_main
  paths:
    include:
      - generators/
      - templates/
      - eng/pipelines/repoman.yml

pr:
  paths:
    include:
      - generators/
      - templates/
      - eng/pipelines/repoman.yml

variables:
  - template: /eng/pipelines/templates/variables/globals.yml

jobs:
  - job: Generate_Repos
    pool:
      name: azsdk-pool-mms-ubuntu-2004-general
      #vmImage: MMSUbuntu20.04

    steps:
      - checkout: self

      - task: NodeTool@0
        inputs:
          versionSpec: 16

      - pwsh: |
          git config --global user.name "$(azuresdk-github-user)"
          git config --global user.email "$(azuresdk-github-email)"
          Set-Content `
            -Value "https://$(azuresdk-github-user):$(azuresdk-github-pat)@github.com" `
            -Path ~/.git-credentials
          git config --global credential.helper "store"
        displayName: Set git credentials

      - pwsh: npm install
        displayName: Install dependencies
        workingDirectory: generators/repo

      - pwsh: npm run build
        displayName: Build
        workingDirectory: generators/repo

      - pwsh: npm link
        displayName: Install repoman locally
        workingDirectory: generators/repo

      - pwsh: |
          $PRNumber = '$(System.PullRequest.PullRequestNumber)'
          if ($env:PRNUMBEROVERRIDE) {
            Write-Host "PR Number override: $($env:PRNUMBEROVERRIDE)"
            $PRNumber = "$($env:PRNUMBEROVERRIDE)"
          }
          Write-Host "##vso[task.setvariable variable=PRNumber]$PRNumber"
        displayName: Set PRNumber

      - pwsh: |
          $targetBranchName = ''
          if ('$(Build.Reason)' -eq 'PullRequest' -or $env:BUILDREASONOVERRIDE -eq 'PullRequest') {
            $targetBranchName = "pr/$(PRNumber)"
            Write-Host "PR Build, using target branch name: $targetBranchName"
          }
          Write-Host "##vso[task.setvariable variable=TargetBranchName]$targetBranchName"
        displayName: Set TargetBranchName

      - task: PowerShell@2
        displayName: Generate Azure-Samples repos
        inputs:
          pwsh: true
          targetType: filePath
          filePath: ./eng/scripts/Invoke-RepomanGenerate.ps1
          arguments: -TargetBranchName "$(TargetBranchName)"

      - pwsh: |
          $repomanContent = "No changes detected."
          $repomanOutputFile = "$([System.IO.Path]::GetTempPath())/repoman.json"
          if (Test-Path $repomanOutputFile) {
            $repomanContent = Get-Content $repomanOutputFile -Raw | ConvertFrom-Json
          }
          $output = ""
          for ($j = 0; $j -lt $repomanContent.count; $j++) { 
          $output = $output + "### Project: **$($repomanContent[$j].metadataName)**`n"
          $results = $repomanContent[$j].results
          for($i = 0; $i -lt $results.count; $i++) { 
            
          $output = $output + @"
          #### Remote: **$($results[$i].remote)**
          ##### Branch: **$($results[$i].branch)**

          You can initialize this project with:
          ``````bash
          azd init -t $($results[$i].org)/$($results[$i].repo) -b $($results[$i].branch)
          ``````

          [View Changes]($($results[$i].branchUrl)) | [Compare Changes]($($results[$i].compareUrl))

          ---

          "@
          }
          }
          $tag ='<!-- #comment-repoman-generate -->'
          $content = @"
          $tag
          ## Repoman Generation Results
          Repoman pushed changes to remotes for the following projects:
          $output
          "@
          $file = New-TemporaryFile
          write-host "Content Temp file path $file"
          Set-Content -Path $file -Value $content
          Write-Host "##vso[task.setvariable variable=CommentBodyFile]$file"
        displayName: Set Repoman Content
        condition: >-
          and(
            succeeded(),
            or(
              eq('PullRequest', variables['BuildReasonOverride']),
              and(
                eq('', variables['BuildReasonOverride']),
                eq(variables['Build.Reason'], 'PullRequest')
              )
            )
          )

      - task: PowerShell@2
        displayName: Post PR comment
        condition: >-
          and(
            succeeded(),
            or(
              eq('PullRequest', variables['BuildReasonOverride']),
              and(
                eq('', variables['BuildReasonOverride']),
                eq(variables['Build.Reason'], 'PullRequest')
              )
            )
          )
        inputs:
          pwsh: true
          targetType: filePath
          filePath: ./eng/scripts/Update-PRComment.ps1
          arguments: >-
            -Repo 'kaizentm/azure-dev'
            -PRNumber '$(PRNumber)'
            -BodyFile '$(CommentBodyFile)'
            -Tag '<!-- #comment-repoman-generate -->'
        env:
          GH_TOKEN: $(azuresdk-github-pat)

      - task: PowerShell@2
        displayName: Repoman Delete Template PR Branch(s)
        condition: >-
          and(
            succeeded(),
            eq(variables['Build.SourceBranch'], 'refs/heads/cse_main')
          )
        inputs:
          pwsh: true
          targetType: filePath
          filePath: ./eng/scripts/Remove-PRBranch.ps1
          arguments: >-
            -CommitId '$(Build.SourceVersion)'
            -Repo "kaizentm/azure-dev"
            -BodyFile  "$([System.IO.Path]::GetTempPath())/repoman.json"
        env:
          GH_TOKEN: $(azuresdk-github-pat)