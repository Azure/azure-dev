parameters:
  SubscriptionConfiguration: $(sub-config-azure-cloud-test-resources)

steps:
  - pwsh: |
      $subscriptionConfiguration = @'
        ${{ parameters.SubscriptionConfiguration }}
      '@ | ConvertFrom-Json -AsHashtable;

      az login `
        --service-principal `
        -u "$($subscriptionConfiguration.TestApplicationId)" `
        -p "$($subscriptionConfiguration.TestApplicationSecret)" `
        --tenant "$($subscriptionConfiguration.TenantId)"

      az account set `
        --subscription "$($subscriptionConfiguration.SubscriptionId)"

      echo "##vso[task.setvariable variable=ARM_CLIENT_ID;issecret=true]$($subscriptionConfiguration.TestApplicationId)"
      echo "##vso[task.setvariable variable=ARM_CLIENT_SECRET;issecret=true]$($subscriptionConfiguration.TestApplicationSecret)"
      echo "##vso[task.setvariable variable=ARM_TENANT_ID;issecret=true]$($subscriptionConfiguration.TenantId)"

    condition: and(succeeded(), ne(variables['Skip.LiveTest'], 'true'))
    displayName: Azure Login
