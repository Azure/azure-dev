parameters:
  TagRepository: false
  VsixVersion: $(VSIX_VERSION)
  StorageContainerName: '`$web'
  PublishToMarketplace: false

steps:
  - ${{ if eq('true', parameters.TagRepository) }}:
    # Perform tag verification before publishing anything
    - pwsh: |
        $existingTag = gh api /repos/$(Build.Repository.Name)/tags --paginate | ConvertFrom-Json | Where-Object { $_.name -eq $tag }
        if ($existingTag) {
            Write-Error "Tag ($(GH_RELEASE_TAG)) exists. Exiting."
            exit 1
        }

        gh release view $(GH_RELEASE_TAG) --repo $(Build.Repository.Name)
        if ($LASTEXITCODE -eq 0) {
            Write-Error "Release ($(GH_RELEASE_TAG)) exists. Exiting."
            exit 1
        }
      displayName: Check for existing tag or release
      env:
        GH_TOKEN: $(azuresdk-github-pat)


  - pwsh: |
      New-Item -ItemType Directory -Path release -Force
      Copy-Item signed/vsix/*.vsix release/
      Copy-Item signed/vsix/*.p7s release/
      Copy-Item signed/vsix/*.manifest release/
      Write-Host "Signed:"
      Get-ChildItem signed/

      Write-Host "Release:"
      Get-ChildItem release/
    displayName: Copy signed vsix to release location

  - task: AzurePowerShell@5
    displayName: Publish files to storage locations
    inputs:
      azureSubscription: 'Azure SDK Artifacts'
      azurePowerShellVersion: LatestVersion
      pwsh: true
      ScriptType: InlineScript
      Inline: |
        $publishLocations = "${{ parameters.PublishLocations }}" -split ';'
        foreach ($location in $publishLocations) {
          Write-Host "Publishing to $location"
          $output = "copy command copy "release/*" "$(publish-storage-location)/${{ parameters.StorageContainerName }}/$location" --overwrite=true"
          Write-Host $output
        }
    env:
      AZCOPY_AUTO_LOGIN_TYPE: 'PSCRED'

  - ${{ if eq('true', parameters.TagRepository) }}:
    - pwsh: |
        Write-Host "Creating GitHub release $(GH_RELEASE_TAG)"
        Write-Host "Notes file:" 
        Get-Content changelog/CHANGELOG.md | Write-Host

        Write-Host "Uploading releases" 
        Get-ChildItem release -Recurse | Select-Object -Property FullName
      displayName: Create GitHub Release and upload artifacts
      env:
        GH_TOKEN: $(azuresdk-github-pat)

  - ${{ if eq('true', parameters.PublishToMarketplace) }}:
    - task: AzureCLI@2
      displayName: Publish (using vsce)
      inputs:
        azureSubscription: azure-sdk-vsmarketplace
        scriptType: pscore
        scriptLocation: inlineScript
        workingDirectory: release
        inlineScript: |
          npm install -g @vscode/vsce
          $baseName = "azure-dev-${{ parameters.VsixVersion }}"
          $output = @"
          the command to publish publish `
            --azure-credential `
            --packagePath "$($baseName).vsix" `
            --manifestPath "$($baseName).manifest" `
            --signaturePath "$($baseName).p7s"
          "@
          Write-Host $output
