# Consumes the following variables from Set-TemplateTestMatrixVariable.ps1:
# - TemplateName
# - TEST_SCENARIO
# and additional variables specified by template-test-generate-jobs.yml

steps:
    - pwsh: |
          npm install -g @devcontainers/cli
      displayName: Install Devcontainer

    - template: /eng/pipelines/templates/steps/install-azd-live-sh.yml
      parameters:
          Version: $(AzdVersion)

    - template: /eng/pipelines/templates/steps/azd-login.yml

    # Java pre-requisites that isn't met
    # TODO: Use azd container as a form of validation that the container works
    - template: /eng/pipelines/templates/steps/install-ms-openjdk.yml

    # Required to clone repos that are not yet public
    - template: /eng/pipelines/templates/steps/set-git-credentials.yml

    - pwsh: |
          # Get the name without any path
          $template = '$(TemplateName)'
          $lastSlash = $template.LastIndexOf('/')
          if ($lastSlash -ne -1) {
            $templateName = $template.Substring($lastSlash + 1)
          } else {
            $templateName = $template
          }
          $scenario = "$env:TEST_SCENARIO"
          $envPrefixName = "azd-template-test"
          if($scenario -ne '') {
            $envPrefixName += "-$scenario"
          } 
          $resourceGroupName = "rg-$envPrefixName-$templateName-$(Build.BuildId)-$(System.JobAttempt)"
          Write-Host "Resource group name: $resourceGroupName"
          Write-Host "##vso[task.setvariable variable=ResourceGroupName]$resourceGroupName"
          Write-Host "##vso[task.setvariable variable=EnvPrefixName]$envPrefixName"

          $SynchronousCleanup = 'true'
          if ('$(Build.Reason)' -eq 'PullRequest' || '$(CleanupHoursDelay)' -ne '0') {
            $SynchronousCleanup = 'false'
          }
          Write-Host "SynchronousCleanup: $SynchronousCleanup"
          Write-Host "##vso[task.setvariable variable=SynchronousCleanup]$SynchronousCleanup"

          $CleanupImmediate = 'true'
          if ('$(CleanupHoursDelay)' -ne '0') {
            $CleanupImmediate = 'false'
          }
          Write-Host "CleanupImmediate: $CleanupImmediate"
          Write-Host "##vso[task.setvariable variable=CleanupImmediate]$CleanupImmediate"
      displayName: Set test run parameters

    - pwsh: |
          git clone --branch $(TemplateBranchName) https://github.com/$(TemplateName).git/ temp
      displayName: Clone template repository

    - task: CopyFiles@2
      inputs:
          SourceFolder: "templates/tests"
          Contents: "test-templates.sh"
          TargetFolder: "$(Build.SourcesDirectory)/temp"
      displayName: Copy test-templates.sh

    - task: AzureCLI@2
      displayName: Azure CLI Login
      inputs:
        azureSubscription: azure-sdk-apiscan
        scriptType: pscore
        scriptLocation: inlineScript
        addSpnToEnvironment: true
        inlineScript: |
          az --version
          az account show -o json
          Write-Host "##vso[task.setvariable variable=ARM_CLIENT_ID;issecret=true]$($env:servicePrincipalId)"
          Write-Host "##vso[task.setvariable variable=ARM_TENANT_ID;issecret=true]$($env:tenantId)"
          Write-Host "##vso[task.setvariable variable=ARM_OIDC_TOKEN;issecret=true]$($env:idToken)"

    - task: DevcontainersCI@0
      inputs:
          env: |
              # Required secrets for Terraform service principal authentication
              # $(arm-*) secrets are set by azd-login.yml
              ARM_CLIENT_ID=$(ARM_CLIENT_ID)
              ARM_TENANT_ID=$(ARM_TENANT_ID)
              ARM_OIDC_TOKEN=$(ARM_OIDC_TOKEN)
              SUBSCRIPTION_ID=$(SubscriptionId-test-tenant)

              # Pass in TemplateRunEnvironmentVariables
              $(VARIABLE_LIST)

              # Bash Script parameters
              BRANCH_NAME=$(TemplateBranchName)
              ENV_NAME_PREFIX=$(EnvPrefixName)
              TEMPLATE_NAME=$(TemplateName)
              VALIDATE=$(TemplateName)
              PLAYWRIGHT_REPORTER='list'
              LOCATION=$(AzureLocation)
              SUBSCRIPTION=$(SubscriptionId-test-tenant)
              ENV_SUFFIX=$(Build.BuildId)-$(System.JobAttempt)
              CLEANUP=$(SynchronousCleanup)

              AZD_VERSION=$(AzdVersion)
              AZD_DEBUG_FORCE_NO_TTY="1"
          subFolder: "$(Build.SourcesDirectory)/temp"
          runCmd: |
              # Uninstall azd version
              curl -fsSL https://aka.ms/uninstall-azd.sh | sudo bash

              # Install azd build
              if [[ $(AzdVersion) == pr/* ]];
              then
                curl -fsSL https://aka.ms/install-azd.sh | sudo bash -s -- --base-url "$(publish-storage-location)/azd/standalone/$(AzdVersion)" --skip-verify --version ''
              else
                curl -fsSL https://aka.ms/install-azd.sh | sudo bash -s -- --version $(AzdVersion) --verbose
              fi

              RUN_VALIDATION=true
              if [[ $TEMPLATE_NAME == *aks* ]]; then
                RUN_VALIDATION=false
              fi

              azd version

              # Login azd
              az login \
                --federated-token "$(ARM_OIDC_TOKEN)" \
                --service-principal \
                -u "$(ARM_CLIENT_ID)" \
                -t "$(ARM_TENANT_ID)"

              azd config set auth.useAzCliAuth true

              # Login az CLI (required for scenarios where az is invoked)
              az login \
                --service-principal \
                -u "$(arm-client-id-test-tenant)" \
                -p="$(arm-client-secret-test-tenant)" \
                --tenant "$(arm-tenant-id-test-tenant)"

              # set default sub for az to be the same used by azd
              az account set --subscription "$(SubscriptionId-test-tenant)"

              # enable alpha features
              azd config set alpha.all on

              # Install these packages for playwright tests. Otherwise, it will cause a error of playwright missing libraries
              sudo add-apt-repository ppa:gstreamer-developers/ppa
              sudo apt-get update
              sudo apt-get install -y gstreamer1.0*
              sudo apt-get install -y gstreamer1.0-libav libnss3-tools libatk-bridge2.0-0 libcups2-dev libxkbcommon-x11-0 libxcomposite-dev libxrandr2 libgbm-dev libgtk-3-0

              # Run template test bash script
              chmod u+x test-templates.sh
              ./test-templates.sh -d \
                -e '$(EnvPrefixName)' \
                -t '$(TemplateName)' \
                -b '$(TemplateBranchName)' \
                -s '$(SubscriptionId-test-tenant)' \
                -u '$(Build.BuildId)-$(System.JobAttempt)' \
                -l '$(AzureLocation)' \
                -p 'list' \
                -c '$(SynchronousCleanup)' \
                -v "$RUN_VALIDATION" \

      displayName: Test templates in Devcontainer

    # First tag the resource group (if exists) so that it can get cleaned up
    # by the cleanup pipeline. Then attempt to delete the resource group
    # directly. If the delete fails the cleanup pipeline will delete it.
    - task: AzureCLI@2
      inputs:
        azureSubscription: azure-sdk-tests
        keepAzSessionActive: true
        scriptType: pscore
        scriptLocation: inlineScript
        inlineScript: |
            $errOutput = ($( $output = & az group show --resource-group '$(ResourceGroupName)' --query id ) 2>&1) -join [System.Environment]::NewLine
            if ($LASTEXITCODE) {
              if ($errOutput -match "ResourceGroupNotFound") {
                Write-Host "Resource group $(ResourceGroupName) has already been deleted."
                exit 0
              }

              Write-Error "Error querying for resource group. Exit code: $LASTEXITCODE, $errOutput"
              exit 1
            }

            $resourceGroupId = $output

            if ('$(CleanupImmediate)' -eq 'true') {
              # Tag the resource group so it gets cleaned up later if delete fails
              az tag create `
                --resource-id $resourceGroupId `
                --tags DeleteAfter="$((Get-Date -AsUTC).ToString('o'))"

              # Attempt to delete the resource group
              az group delete --resource-group $(ResourceGroupName) --yes --no-wait
            } else {
              $delayInHours = [int]'$(CleanupHoursDelay)'
              # Tag the resource group for delayed cleanup
              az tag create `
                --resource-id $resourceGroupId `
                --tags DeleteAfter="$((Get-Date -AsUTC).AddHours($delayInHours).ToString('o'))"
            }
      condition: always()
      displayName: Tag resource group for deletion
